dirPath = 'C:/Master/data/cmems_data/global_10km/2016/'; %gets directory
myFiles = dir(fullfile(dirPath,'*.nc')); %gets all wav files in struct
   
fig = uifigure('Name','My Figure');
pnl = uipanel(fig);
btn = uibutton(pnl);

rectangles = [];
i = 1;
newRectButton(rectangles, i);

for k = 1:length(myFiles) 
    
    % Create figure
    figHandle = figure('Name','Measured Data', 'position', [200 100 1400 900]);
    clf()
   
    axPrimary = axes('Units','Normalize','Box','on'); 
    axSecondary = axes('Units','Normalize','Box','on'); 
    scale = 0.3;  % percentage of original size
    axSecondary.Position(3:4) = scale * axSecondary.Position(3:4); 
    axSecondary.Position(1:2) = axPrimary.Position(1:2) + axPrimary.Position(3:4)*(1-scale); 

    % Open netcdf variables
    fName = myFiles(k).name;
    fpath = fullfile(dirPath, fName);
    fprintf(1, 'Now reading %s\n', fpath);
    lon = ncread(fpath,'longitude') ; nx = length(lon) ; 
    lat = ncread(fpath,'latitude') ; ny = length(lat) ; 
    time = ncread(fpath,'time') ;

    z = ncread(fpath,'zos',[1 1 1],[nx ny 1]);
    [~, ch] = contourf(axPrimary,lon,lat,z',30); 
    
    % Choose section to isolate
    xSection = [-30, -25];  % x-bounds
    ySection = [50, 52];  % y-bounds
    
    % Get index values of section
    xIdx = ch.XData >= xSection(1) & ch.XData <= xSection(2); 
    yIdx = ch.YData >= ySection(1) & ch.YData <= ySection(2);
    
    % Plot section in secondary axis
    [~, ch2] = contourf(axSecondary, ch.XData(xIdx), ch.YData(yIdx), ch.ZData(yIdx,xIdx), 30);
    ch2.LevelList = ch.LevelList; 
    %caxis(axSecondary, caxis(axPrimary));
    axis(axPrimary);
    axis(axSecondary);
    % Show the section in the main axis, if you want to.
    rectangle(axPrimary,'Position',[xSection(1),ySection(1),range(xSection),range(ySection)]);

    %roi = images.roi.Rectangle
    %addlistener(roi,'MovingROI',@movingCallback);
    %roi.draw; 
    
    while ishandle(figHandle)
    end
end

function rectArr, idx = newRectButton(rectArr, idx)
    % Create a figure window
    fig = uifigure;

    % Create a push button
    btn = uibutton(fig,'push',...
                   'Position',[420, 218, 100, 22],...
                   'ButtonPushedFcn', @(btn,event) newRectButtonPushed(rectArr, idx));
end

function newRectButtonPushed(rectArr, idx)
    rectArr = [rectArr getrect];
    idx = idx + 1;
    disp(idx)
end